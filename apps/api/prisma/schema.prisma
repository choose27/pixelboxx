// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model - core authentication and profile
model User {
  id            String    @id @default(uuid())
  username      String    @unique @db.VarChar(32)
  email         String    @unique @db.VarChar(255)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  displayName   String?   @map("display_name") @db.VarChar(64)
  avatarUrl     String?   @map("avatar_url") @db.VarChar(500)
  role          Role      @default(USER)
  isVerified    Boolean   @default(false) @map("is_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  sessions           Session[]
  ownedBoxxes        Boxx[]              @relation("OwnedBoxxes")
  boxxMembers        BoxxMember[]
  messages           Message[]
  reactions          Reaction[]
  invites            BoxxInvite[]

  // Social relations
  sentFriendRequests     Friendship[]  @relation("SentRequests")
  receivedFriendRequests Friendship[]  @relation("ReceivedRequests")
  topFriends             TopFriend[]   @relation("UserTopFriends")
  topFriendOf            TopFriend[]   @relation("FriendTopFriends")
  followers              Follow[]      @relation("Following")
  following              Follow[]      @relation("Followers")
  blocksMade             Block[]       @relation("BlocksMade")
  blocksReceived         Block[]       @relation("BlocksReceived")
  notifications          Notification[]
  notificationPreferences NotificationPreferences?
  activities             Activity[]

  @@map("users")
}

// Role enum
enum Role {
  USER
  MOD
  ADMIN
}

// Session model - for JWT refresh tokens
model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  refreshToken String   @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Boxxes (Discord-style servers/communities)
model Boxx {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(64)
  slug        String   @unique @db.VarChar(64)
  description String?  @db.Text
  iconUrl     String?  @map("icon_url") @db.VarChar(500)
  bannerUrl   String?  @map("banner_url") @db.VarChar(500)
  ownerId     String   @map("owner_id")
  isPublic    Boolean  @default(true) @map("is_public")
  memberCount Int      @default(0) @map("member_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  owner       User     @relation("OwnedBoxxes", fields: [ownerId], references: [id])
  members     BoxxMember[]
  channels    Channel[]
  roles       BoxxRole[]
  invites     BoxxInvite[]

  @@map("boxxes")
}

model BoxxMember {
  id        String   @id @default(uuid())
  boxxId    String   @map("boxx_id")
  userId    String   @map("user_id")
  roleId    String?  @map("role_id")
  joinedAt  DateTime @default(now()) @map("joined_at")

  boxx      Boxx     @relation(fields: [boxxId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      BoxxRole? @relation(fields: [roleId], references: [id])

  @@unique([boxxId, userId])
  @@map("boxx_members")
}

model BoxxRole {
  id          String   @id @default(uuid())
  boxxId      String   @map("boxx_id")
  name        String   @db.VarChar(32)
  color       String?  @db.VarChar(7)  // Hex color
  permissions Int      @default(0)     // Bitfield
  position    Int      @default(0)

  boxx        Boxx     @relation(fields: [boxxId], references: [id], onDelete: Cascade)
  members     BoxxMember[]

  @@map("boxx_roles")
}

model BoxxInvite {
  id        String   @id @default(uuid())
  boxxId    String   @map("boxx_id")
  code      String   @unique @db.VarChar(16)
  creatorId String   @map("creator_id")
  maxUses   Int?     @map("max_uses")
  useCount  Int      @default(0) @map("use_count")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  boxx      Boxx     @relation(fields: [boxxId], references: [id], onDelete: Cascade)
  creator   User     @relation(fields: [creatorId], references: [id])

  @@map("boxx_invites")
}

// Channels within Boxxes
model Channel {
  id        String      @id @default(uuid())
  boxxId    String      @map("boxx_id")
  name      String      @db.VarChar(64)
  topic     String?     @db.VarChar(500)
  type      ChannelType @default(TEXT)
  position  Int         @default(0)
  createdAt DateTime    @default(now()) @map("created_at")

  boxx      Boxx        @relation(fields: [boxxId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@map("channels")
}

enum ChannelType {
  TEXT
  VOICE
  ANNOUNCEMENT
}

// Messages in channels
model Message {
  id          String   @id @default(uuid())
  channelId   String   @map("channel_id")
  authorId    String   @map("author_id")
  content     String   @db.Text
  attachments Json?    // Array of attachment objects
  embeds      Json?    // Rich embeds
  replyToId   String?  @map("reply_to_id")
  isPinned    Boolean  @default(false) @map("is_pinned")
  isDeleted   Boolean  @default(false) @map("is_deleted")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  author      User     @relation(fields: [authorId], references: [id])
  replyTo     Message? @relation("Replies", fields: [replyToId], references: [id])
  replies     Message[] @relation("Replies")
  reactions   Reaction[]

  @@index([channelId, createdAt])
  @@map("messages")
}

// Reactions on messages
model Reaction {
  id        String   @id @default(uuid())
  messageId String   @map("message_id")
  userId    String   @map("user_id")
  emoji     String   @db.VarChar(64)  // Unicode or custom emote ID
  createdAt DateTime @default(now()) @map("created_at")

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
  @@map("reactions")
}

// ============================================
// SOCIAL GRAPH MODELS
// ============================================

// Friendships - bidirectional connections
model Friendship {
  id          String           @id @default(uuid())
  requesterId String           @map("requester_id")
  addresseeId String           @map("addressee_id")
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  requester   User             @relation("SentRequests", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee   User             @relation("ReceivedRequests", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([addresseeId, status])
  @@index([requesterId, status])
  @@map("friendships")
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

// Top Friends - THE DRAMA FEATURE
model TopFriend {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  friendId  String   @map("friend_id")
  position  Int      // 1-8
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation("UserTopFriends", fields: [userId], references: [id], onDelete: Cascade)
  friend    User     @relation("FriendTopFriends", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, position])
  @@unique([userId, friendId])
  @@index([userId])
  @@map("top_friends")
}

// Follow system - public following
model Follow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  follower    User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followingId])
  @@index([followerId])
  @@map("follows")
}

// Block system - essential safety feature
model Block {
  id        String   @id @default(uuid())
  blockerId String   @map("blocker_id")
  blockedId String   @map("blocked_id")
  createdAt DateTime @default(now()) @map("created_at")

  blocker   User     @relation("BlocksMade", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("BlocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@map("blocks")
}

// ============================================
// NOTIFICATION SYSTEM
// ============================================

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  data      Json             // Flexible payload
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read, createdAt])
  @@map("notifications")
}

enum NotificationType {
  // Social
  FRIEND_REQUEST
  FRIEND_ACCEPTED
  NEW_FOLLOWER
  TOP_FRIEND_ADDED
  TOP_FRIEND_REMOVED

  // Content
  GUESTBOOK_ENTRY
  MESSAGE_MENTION

  // Boxxes
  BOXX_INVITE
  BOXX_JOIN
  CHANNEL_MENTION

  // System
  WELCOME
  PROFILE_VIEW_MILESTONE
}

model NotificationPreferences {
  id              String  @id @default(uuid())
  userId          String  @unique @map("user_id")

  // Email notifications (not implemented yet, just preferences)
  emailEnabled    Boolean @default(false) @map("email_enabled")
  emailDigest     Boolean @default(false) @map("email_digest")

  // Push notifications (not implemented yet, just preferences)
  pushEnabled     Boolean @default(true) @map("push_enabled")

  // Per-type toggles
  friendRequests   Boolean @default(true) @map("friend_requests")
  guestbookEntries Boolean @default(true) @map("guestbook_entries")
  mentions         Boolean @default(true)
  boxxInvites      Boolean @default(true) @map("boxx_invites")

  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ============================================
// ACTIVITY FEED
// ============================================

model Activity {
  id        String       @id @default(uuid())
  userId    String       @map("user_id")
  type      ActivityType
  data      Json
  createdAt DateTime     @default(now()) @map("created_at")

  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("activities")
}

enum ActivityType {
  PROFILE_UPDATED
  PHOTOS_ADDED
  JOINED_BOXX
  NEW_FRIEND
  TOP_FRIENDS_CHANGED
  THEME_CHANGED
}

// ============================================
// AI & MODERATION
// ============================================

// Moderation Queue - AI content moderation
model ModerationQueue {
  id          String           @id @default(uuid())
  contentType ContentType      @map("content_type")
  contentId   String           @map("content_id")
  userId      String           @map("user_id")
  status      ModerationStatus @default(PENDING)
  aiScore     Float?           @map("ai_score")
  aiReason    String?          @map("ai_reason") @db.Text
  reviewerId  String?          @map("reviewer_id")
  reviewedAt  DateTime?        @map("reviewed_at")
  createdAt   DateTime         @default(now()) @map("created_at")

  @@index([status, createdAt])
  @@index([userId])
  @@map("moderation_queue")
}

enum ContentType {
  PROFILE_IMAGE
  GALLERY_IMAGE
  MESSAGE
  GUESTBOOK
  CUSTOM_EMOTE
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
}
